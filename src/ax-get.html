<div>
	{@html html}
</div>
<script>
	import TemplateEngine from './app';
	import store from './store';
	import axios from 'axios';

	export default {
		store: () => store,
		tag: 'ax-get',
		props: ["url", "collection"],

		data() {
			return {
				html: ""
			}
		},

		oncreate() {
			const template = this.querySelector('[ax-iterator]');
			this.store.on("CONFIG_SET", (config) => {
				let url = "";
				if (this.store.get().config.baseUrl) {
					url = this.store.get().config.baseUrl + this.collection;
				} else if (this.url) {
					url = this.url;
				} else {
					this.set({
						error: "URL Must be defined"
					})
				}
				this.getAll(url);
			});
			this.store.on("COLLECTION_UPDATED", (coll) => {
				this.render(template, this.store.get().collections[this.collection]);
			})

		},
		methods: {
			getAll(url, params) {
				const template = this.querySelector('[ax-iterator]');
				axios.get(url)
					.then((res) => {
						let resource = this.store.get().collections;
						this.store.fire("GETALL_COMPLETED", {
							collection: this.collection,
							data: res.data
						});
						resource[this.collection] = res.data;
						this.store.set({
							collections: resource
						});
						this.render(template, this.store.get().collections[this.collection]);
					})
			},
			render(tpl, data) {
				let iterator = tpl.innerHTML;
				tpl.innerHTML = "";

				let html = "";
				data.map((item) => {
					html += TemplateEngine(iterator, item);
				});
				tpl.innerHTML = html;
				console.log(tpl)
				this.set({
					html: tpl.outerHTML
				});
			}
		}
	}
</script>